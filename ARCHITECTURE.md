# 系統架構文件

## 整體架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                        使用者介面層                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Web 瀏覽器 (templates/index.html)                   │    │
│  │  - 檔案上傳區                                        │    │
│  │  - 處理進度顯示                                      │    │
│  │  - Markdown 預覽                                     │    │
│  │  - 下載按鈕                                          │    │
│  └─────────────────────────────────────────────────────┘    │
│                          ↕ HTTP                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      應用程式層 (Flask)                        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  src/app.py - Flask 應用主程式                       │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐      │    │
│  │  │ /upload   │  │ /download │  │ /health   │      │    │
│  │  │ 處理上傳  │  │ 下載檔案  │  │ 健康檢查  │      │    │
│  │  └───────────┘  └───────────┘  └───────────┘      │    │
│  └─────────────────────────────────────────────────────┘    │
│                          ↕                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                        服務層                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  src/services/ocr_service.py                        │    │
│  │  - process_document()                               │    │
│  │  - process_uploaded_file()                          │    │
│  │  - 協調 API 呼叫                                     │    │
│  │  - 管理檔案輸入/輸出                                 │    │
│  └─────────────────────────────────────────────────────┘    │
│         ↓                            ↓                       │
│  ┌──────────────┐            ┌──────────────┐              │
│  │ API 客戶端    │            │ 轉換器        │              │
│  └──────────────┘            └──────────────┘              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      整合層                                   │
│  ┌───────────────────────┐  ┌───────────────────────┐      │
│  │ src/api/              │  │ src/utils/            │      │
│  │ alphaxiv_client.py    │  │ markdown_converter.py │      │
│  │                       │  │ file_validator.py     │      │
│  │ - process_pdf()       │  │                       │      │
│  │ - HTTP 請求處理       │  │ - Markdown 轉換       │      │
│  │ - 錯誤處理            │  │ - 檔案驗證            │      │
│  └───────────────────────┘  └───────────────────────┘      │
│          ↓                                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     外部服務                                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  AlphaXiv DeepSeek OCR API                          │    │
│  │  https://api.alphaxiv.org/models/v1/deepseek/       │    │
│  │              deepseek-ocr/inference                 │    │
│  │                                                      │    │
│  │  - 接收 PDF 檔案                                     │    │
│  │  - 執行 OCR 識別                                     │    │
│  │  - 返回文字結果                                      │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      儲存層                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  uploads/    │  │  outputs/    │  │  static/     │      │
│  │  (暫存)      │  │  (Markdown)  │  │  (CSS/JS)    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 資料流程圖

```
使用者上傳 PDF
     │
     ↓
┌─────────────────────┐
│  前端驗證             │
│  - 檔案格式          │
│  - 檔案大小          │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  POST /upload       │
│  (multipart/form)   │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  Flask 路由處理      │
│  - 接收檔案          │
│  - 伺服器端驗證      │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  儲存暫存檔案        │
│  (uploads/)         │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  OCR 服務            │
│  process_document() │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  AlphaXiv 客戶端     │
│  process_pdf()      │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  HTTP POST 到        │
│  AlphaXiv API       │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  DeepSeek OCR       │
│  處理 PDF            │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  返回 OCR 結果       │
│  (JSON)             │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  Markdown 轉換器     │
│  convert_to_md()    │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  儲存 Markdown       │
│  (outputs/)         │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  返回結果給前端      │
│  - Markdown 內容     │
│  - 檔案名稱          │
│  - 元資料            │
└─────────────────────┘
     │
     ↓
┌─────────────────────┐
│  前端渲染結果        │
│  - 預覽              │
│  - 下載              │
└─────────────────────┘
```

## 模組依賴關係

```
app.py
  │
  ├─→ services/ocr_service.py
  │     │
  │     ├─→ api/alphaxiv_client.py
  │     │     └─→ requests (外部套件)
  │     │
  │     └─→ utils/markdown_converter.py
  │
  └─→ utils/file_validator.py
```

## 前端架構

```
templates/index.html
  │
  ├─→ static/css/style.css
  │     ├─ 全域樣式
  │     ├─ 元件樣式
  │     ├─ 響應式設計
  │     └─ 動畫效果
  │
  └─→ static/js/app.js
        ├─ 檔案上傳處理
        ├─ AJAX 請求
        ├─ Markdown 渲染
        ├─ UI 狀態管理
        └─ 錯誤處理

外部依賴:
  └─→ marked.js (CDN)
        └─ Markdown → HTML 轉換
```

## 部署架構

### 開發環境

```
┌────────────────────────────┐
│  本地開發機器               │
│  ┌──────────────────────┐  │
│  │  Flask Dev Server    │  │
│  │  Port: 5000          │  │
│  │  Debug: True         │  │
│  └──────────────────────┘  │
│          │                  │
│  ┌──────────────────────┐  │
│  │  檔案系統             │  │
│  │  - uploads/          │  │
│  │  - outputs/          │  │
│  └──────────────────────┘  │
└────────────────────────────┘
```

### Docker 部署

```
┌────────────────────────────────────┐
│  Docker 容器                        │
│  ┌──────────────────────────────┐  │
│  │  Python 3.10 環境            │  │
│  │  ┌────────────────────────┐  │  │
│  │  │  Flask 應用             │  │  │
│  │  │  Gunicorn (可選)        │  │  │
│  │  │  Port: 5000             │  │  │
│  │  └────────────────────────┘  │  │
│  └──────────────────────────────┘  │
│          │                          │
│  ┌──────────────────────────────┐  │
│  │  Volume 掛載                 │  │
│  │  - ./uploads:/app/uploads    │  │
│  │  - ./outputs:/app/outputs    │  │
│  └──────────────────────────────┘  │
└────────────────────────────────────┘
         │
         ↓ 映射到
┌────────────────────────────────────┐
│  主機                               │
│  localhost:5000                    │
└────────────────────────────────────┘
```

### 生產環境（建議）

```
┌─────────────────────────────────────────┐
│  反向代理 (Nginx)                        │
│  ┌───────────────────────────────────┐  │
│  │  SSL/TLS 終止                     │  │
│  │  靜態檔案服務                     │  │
│  │  負載平衡                         │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
                  │
    ┌─────────────┴─────────────┐
    ↓                           ↓
┌─────────────┐         ┌─────────────┐
│  Flask 實例 1│         │  Flask 實例 2│
│  (Gunicorn) │         │  (Gunicorn) │
│  Port: 8001 │         │  Port: 8002 │
└─────────────┘         └─────────────┘
    │                           │
    └─────────────┬─────────────┘
                  ↓
    ┌──────────────────────────┐
    │  共享儲存                 │
    │  - NFS / S3              │
    │  - uploads/              │
    │  - outputs/              │
    └──────────────────────────┘
```

## 安全性架構

```
┌─────────────────────────────────────┐
│  輸入驗證層                          │
│  ┌───────────────────────────────┐  │
│  │  前端驗證                     │  │
│  │  - 檔案類型                   │  │
│  │  - 檔案大小                   │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │  後端驗證                     │  │
│  │  - FileValidator             │  │
│  │  - secure_filename()         │  │
│  │  - MIME 類型檢查              │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────────┐
│  處理層                              │
│  ┌───────────────────────────────┐  │
│  │  - 暫存檔案隔離               │  │
│  │  - 處理後自動清理             │  │
│  │  - 錯誤捕獲和日誌             │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────────┐
│  輸出層                              │
│  ┌───────────────────────────────┐  │
│  │  - 安全的檔案名稱生成         │  │
│  │  - Content-Type 標頭          │  │
│  │  - 下載權限控制               │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

## 錯誤處理流程

```
┌─────────────┐
│  請求開始    │
└─────────────┘
      │
      ↓
┌─────────────────────┐
│  try:               │
│    驗證輸入         │────→ ValidationError ──┐
│    處理檔案         │────→ FileError ────────┤
│    呼叫 API         │────→ APIError ─────────┤
│    轉換格式         │────→ ConversionError ──┤
│    儲存結果         │────→ IOError ──────────┤
└─────────────────────┘                        │
      │                                        │
      ↓                                        ↓
┌─────────────┐                    ┌────────────────┐
│  返回成功    │                    │  except:       │
│  結果        │                    │    記錄錯誤    │
└─────────────┘                    │    返回錯誤    │
                                   │    訊息給使用者│
                                   └────────────────┘
```

## 效能考量

### 快取策略
- 靜態資源 (CSS/JS) - 瀏覽器快取
- API 回應 - 無快取（每次都是新的 OCR 結果）

### 並發處理
- Flask 開發伺服器: 單執行緒
- Gunicorn 生產: 多 worker 進程
- 建議 worker 數量: (2 × CPU 核心) + 1

### 檔案處理
- 串流上傳 - 減少記憶體使用
- 自動清理 - 防止磁碟空間耗盡
- 大小限制 - 16 MB 上限

## 監控和日誌

```
┌─────────────────────────────────┐
│  應用層日誌                      │
│  - 請求/回應                     │
│  - 處理時間                      │
│  - 錯誤追蹤                      │
└─────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────┐
│  服務層日誌                      │
│  - OCR 處理狀態                  │
│  - API 呼叫                      │
│  - 檔案操作                      │
└─────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────┐
│  整合層日誌                      │
│  - API 請求/回應                 │
│  - 轉換過程                      │
│  - 驗證結果                      │
└─────────────────────────────────┘
```

## 擴展性設計

### 水平擴展
- 多個 Flask 實例
- 負載平衡器
- 共享檔案儲存

### 垂直擴展
- 增加 CPU/記憶體
- 優化 worker 數量
- 資料庫快取（未來）

### 功能擴展
- 模組化設計
- 清晰的介面定義
- 鬆耦合架構
